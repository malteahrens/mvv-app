"use strict";function gestureStart(){for(i=0;i<metas.length;i++)"viewport"==metas[i].name&&(metas[i].content="width=device-width, minimum-scale=0.25, maximum-scale=1.6")}angular.module("angularApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngCordova","pascalprecht.translate","angular-vibrator","geolocation","ngCordova","nvd3","ui.bootstrap"]).config(["$routeProvider","$translateProvider","vibratorProvider",function(a,b,c){b.translations("de_DE",{APP_HEADLINE:"MVV München",SUB_HEADLINE:"",HEADING1:"Statistiken",PARA1:"",APP_TEXT:"Irgendein Text über eine großartige AngularJS App."}),b.translations("en_US",{APP_HEADLINE:"MVV Munich",SUB_HEADLINE:"",PARA2:"English Translation",HEADING1:"Statistics"}),b.preferredLanguage("de_DE"),b.fallbackLanguage(["de_DE"]),b.useCookieStorage();var d={"default":900,twice:[200,100,300],"long":2500};c.setSequences(d)}]);var metas=document.getElementsByTagName("meta"),i;if(navigator.userAgent.match(/iPhone/i)){for(i=0;i<metas.length;i++)"viewport"==metas[i].name&&(metas[i].content="width=device-width, minimum-scale=1.0, maximum-scale=1.0");document.addEventListener("gesturestart",gestureStart,!1)}angular.module("angularApp").controller("MainCtrl",["$scope",function(a){a.imgSrc="images/yeoman.png",a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.things=[{item:"one"},{item:"two"},{item:"three"}],a.mouseOverThing=function(a){}}]),angular.module("angularApp").controller("LangCtrl",["$scope","$translate",function(a,b){a.changeLang=function(a){b.use(a).then(function(a){console.log("Sprache zu "+a+" gewechselt.")},function(a){console.log("Could not find key."+a)})},a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("angularApp").directive("mouseover",function(){return{restrict:"EA",link:function(a,b,c){b.bind("mouseenter",function(b){a.$apply(function(){a.imgSrc=c.mouseover})})}}}),angular.module("angularApp").directive("fadeIn",["$animate",function(a){return{restrict:"A",scope:{ngSrc:"@"},link:function(b,c,d){c.on("load",function(){}).on("error",function(){console.log("error loading image")}),b.$watch("ngSrc",function(b){var d;void 0!=d&&(a.cancel(d),a.removeClass(c,"fadein")),d=a.addClass(c,"fadein"),d.then(function(){a.removeClass(c,"fadein")})})}}}]);var cordovaModule=angular.module("cordova",[]);cordovaModule.factory("deviceReady",function(){return console.log("factory loaded"),function(a){console.log("inside factory");var b=-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://");a()}});var geolocationModule=angular.module("geolocation",["cordova"]);geolocationModule.factory("getCurrentPosition",["deviceReady","$document","$window","$rootScope",function(a,b,c,d){return console.log("device ready..."),function(b){console.log("function call"),a(function(){navigator.geolocation.getCurrentPosition(function(a){d.$apply(function(){})},function(a){d.$apply(function(){throw alert("got error during locating"),new Error("Unable to retreive position")})})})}}]),angular.module("angularApp").controller("VibrationsCtrl",["$scope","vibrator",function(a,b){a.vibrate=function(a){b.vibrate(a)}}]),angular.module("angularApp").controller("CordovaCtrl",["$scope","$cordovaDevice",function(a,b){console.log("controller loaded..."),console.log("device");var c=b.getDevice();console.log(c)}]),angular.module("angularApp").service("StatModel",function(){var a=[],b=function(b){console.log("register callback for "+b.id),a.push(b)},c=function(b,c){angular.forEach(a,function(a){console.log("notify observer "+a.id+" about change "+c),console.log(b),a.notify(b,c)})},d=!1,e=0,f=0,g={monthly:{timeframe:"this_1_month",timeframeName:"Monat",interval:"every_week"},dayly:{timeframe:"this_1_day",timeframeName:"Heute",interval:"every_hour"},hourly:{timeframe:"this_1_hour",timeframeName:"Stunde",interval:"every_minute"},live:{pollingInterval:5e3,timeframe:"this_1_hour",timeframeName:"Stunde",interval:"every_minute"}},h=function(){return f},i=function(a){return e},j=function(a){f=a,c(f,"totalNumberOfDelays")},k=function(a){e=a,c(e,"countReports")},l=[],m=function(){console.log("getData");var a=new Date(2015,9,20);return a.setTime(a.getTime()+a.getTimezoneOffset()),r(l,a)},n=function(a){l=a,c(l,"dataSet")},o=function(a){console.log(a),l[0].values.push(a)},p=function(a){d="live"===a?!0:!1,console.log("interval mode: "+a),c(g[a],"intervalChange")},q=!1,r=function(a,b){if(!q)return a;console.log("filter"),d&&(b=new Date,b.setHours(b.getHours()-1));var c=new Date;c.setHours(23,59,0,0),console.log(c);var e=[];if(e[0]={key:"abc",values:[]},a.length>0)for(var f=0;f<a[0].values.length;f++)b.getTime()<a[0].values[f].label&&c.getTime()>a[0].values[f].label&&e[0].values.push({label:a[0].values[f].label,value:a[0].values[f].value});return e};return{registerOberserver:b,getData:m,setData:n,addData:o,setInterval:p,countReports:i,TotalNumberOfDelays:h,setCountReports:k,setTotalNumberOfDelays:j}}),angular.module("angularApp").service("StatSrvc",["StatModel",function(a){var b=function(a){notifyObserver(a,"requestLive")};return{requestLive:b}}]),angular.module("angularApp").controller("StatCtrl",["$scope","MvvSrvc","KeenSrvc","StatModel",function(a,b,c,d){a.interval="every_hour";var e="this_1_day";a.timeframeName="Heute",a.totalLiveDelay=0;var f={id:"reportQuery",operation:"count",event_collection:"notifications_start",timeframe:e,timezone:"UTC"},g={id:"delaysQuery",operation:"count",event_collection:"statistics",target_property:"totalNumberOfDelays",timeframe:e,timezone:"UTC"},h={id:"liveDelaysQuery",operation:"average",method:"set",event_collection:"statistics",target_property:"totalNumberOfDelays",timeframe:e,interval:"daily",timezone:"UTC"},i={id:"liveTrainsQuery",operation:"median",event_collection:"statistics",target_property:"totalNumberOfTrains",timeframe:e,interval:"hourly",timezone:"UTC"};a.data=d.getData(),a.options={chart:{type:"lineChart",height:300,margin:{top:20,right:20,bottom:60,left:30},x:function(a){return a.label},y:function(a){return a.value},showValues:!0,valueFormat:function(a){return d3.format(",.4f")(a)},transitionDuration:500,useInteractiveGuideline:!0,xAxis:{axisLabelDistance:30,tickFormat:function(a){return d3.time.format("%X")(new Date(a))}},yAxis:{axisLabel:"Y Axis",axisLabelDistance:30}}},a.countReports=d.countReports();var j={id:"statistic.controller.js",notify:function(e,j){"totalNumberOfDelays"===j&&(a.totalNumberOfDelays=e),"countReports"===j&&(a.countReports=e),"dataSet"===j&&(a.data.length=0,Array.prototype.push.apply(a.data,d.getData())),"intervalChange"===j&&(console.log("got intervalChange in statistic.controller.js"),console.log(e.timeframe),console.log(e.interval),a.interval=e.interval,a.timeframeName=e.timeframeName,f.timeframe=e.timeframe,g.timeframe=e.timeframe,h.timeframe=e.timeframe,i.timeframe=e.timeframe,e.pollingInterval?b.startPolling(e.pollingInterval):(b.stopPolling(),a.countReports="~ ~ ~",a.totalNumberOfDelays="~ ~ ~",c.execute(f),c.execute(g),c.execute(h)))}};d.registerOberserver(j)}]),angular.module("angularApp").controller("MapCtrl",["$scope","MapSrvc","MapModel",function(a,b,c){map=new L.Map("map"),a.delayPoints=[];var d="pk.eyJ1IjoiZmxhbWVkIiwiYSI6ImFHcEx0TFUifQ.Z9j42rwRf12ZElzGiTsoFw",e=L.tileLayer("https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}@2x.png?access_token="+d,{attribution:'<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'});L.control.fullscreen().addTo(map),map.setView(new L.LatLng(48.135125,11.581981),11),map.addLayer(e);var f=L.heatLayer(a.delayPoints,{maxZoom:18,radius:20}).addTo(map);a.liveMode=function(){return b.getLive()};var g={id:"map.controller.js",notify:function(b,c){var d=parseInt(b.x)/1e6,e=parseInt(b.y)/1e6;a.delayPoints.push(new L.LatLng(e,d,b.delay)),a.delayPoints.length>500&&(console.log("shift"),a.delayPoints.shift()),f.redraw()}};c.registerOberserver(g)}]),angular.module("angularApp").service("MapSrvc",["MapModel",function(a){var b=!1,c=function(a){console.log("set live mode: "+a),b=a},d=function(){return b},e=function(b){a.setData(b)},f=function(b){a.addData(b)};return{setData:e,addData:f,setLive:c,getLive:d}}]),angular.module("angularApp").service("MapModel",function(){var a=[],b=function(b){console.log("registered callback for "+b.id),a.push(b)},c=function(b,c){angular.forEach(a,function(a){console.log("notify observer "+a.id+" about change "+c),a.notify(b,c)})},d=[],e=function(){},f=function(a){d=a,c(d,"dataSet")},g=function(a){d.push(a),c(a,"dataAdd")};return{registerOberserver:b,getData:e,setData:f,addData:g}}),angular.module("angularApp").service("MvvSrvc",["$http","$interval","StatModel","MapModel","MapSrvc",function(a,b,c,d,e){var f,g="https://cors-mvv.herokuapp.com/bin/540/query.exe/dny?look_minx=10744745&look_maxx=12440389&look_miny=47825027&look_maxy=48406811&tpl=trains2json&look_productclass=16&look_json=yes&performLocating=1&look_nv=zugposmode|3|get_ageofreport|yes|get_rtmsgstatus|yes|get_linenumber|no|interval|10000|intervalstep|10000|&unique=1444761619000&",h=function(){a({method:"GET",url:g}).then(function(a){var b=0;for(i=0;i<a.data.look.trains.length;i++){var e=parseInt(a.data.look.trains[i].delay);b+=e,e>2&&d.addData(a.data.look.trains[i])}var f=new Date;c.addData({label:+f,value:b})},function(a){console.log("error")})},j=function(a){angular.isDefined(f)||(f=b(h,a,100),e.setLive(!0))},k=function(){angular.isDefined(f)&&(b.cancel(f),f=void 0),e.setLive(!1)};return{startPolling:j,stopPolling:k}}]),angular.module("angularApp").service("KeenSrvc",["$http","$interval","StatModel",function(a,b,c){var d,e={projectId:"561925d196773d74b138cefd",readKey:"363fa49e3c02ebb483fb0dd2f219a9347243c32562720fd877abd34e206a545bb7923dc478beb1f18be28ab3459338b41946d3288768d6e33b8c883c8592cc3b439dc09330b6f7a1f27e1a9c152db2079ede12b53204e91e547350dcf02fdd7abcd671dc0291a68d94f2798639e40a89",protocol:"https",host:"api.keen.io/3.0"},f=function(b){var d={method:"POST",url:e.protocol+"://"+e.host+"/projects/"+e.projectId+"/queries/"+b.operation,headers:{Authorization:e.readKey},data:b};a(d).success(function(a,d){if("reportQuery"===b.id&&c.setCountReports(a.result),"delaysQuery"===b.id&&c.setTotalNumberOfDelays(a.result),"liveDelaysQuery"===b.id)for(var e=0,f=[];e<a.result.length;){if(null!=a.result[e].value){var g=new Date(a.result[e].timeframe.start);f.push({label:+g,value:a.result[e].value})}e==a.result.length-1&&c.setData([{key:"∑ Verspätungen in Minuten",values:f}]),e++}})},g=function(a,c){angular.isDefined(d)||(d=b(f,c,100))},h=function(a){angular.isDefined(d)&&(b.cancel(d),d=void 0)};return{startPolling:g,stopPolling:h,execute:f}}]),angular.module("angularApp").controller("ButtonsCtrl",["$scope","StatModel",function(a,b){a.radioModel="monthly",a.$watch("radioModel",function(a,c){b.setInterval(a)})}]);